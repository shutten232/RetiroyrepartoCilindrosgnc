<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CRPC Quiroga – Retiro de cilindros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --rojo:#d50000;
      --rojo-osc:#a80000;
      --amarillo:#ffd600;
      --fondo:#f4f4f4;
      --card:#ffffff;
      --borde:#dddddd;
      --texto:#111111;
      --texto-suave:#555555;
    }

    *{
      box-sizing:border-box;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      margin:0;
      padding:10px;
      background:var(--fondo);
      color:var(--texto);
      font-size:16px;
    }

    body.orden-open{
      overflow:hidden;
    }

    .page{
      max-width:1100px;
      margin:0 auto;
    }

    /* SPLASH / LOGO */
    .splash-overlay{
      position:fixed;
      inset:0;
      background:var(--rojo);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9000;
      animation:splashFade 2.7s ease-in-out forwards;
    }
    .splash-logo-wrapper{
      text-align:center;
      color:#ffffff;
    }
    .splash-logo-circle{
      width:96px;
      height:96px;
      border-radius:50%;
      border:4px solid var(--amarillo);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:56px;
      font-weight:900;
      color:var(--amarillo);
      box-shadow:0 6px 18px rgba(0,0,0,0.4);
      margin:0 auto 12px;
      background:rgba(0,0,0,0.15);
      animation:splashLogo 2.7s ease-in-out forwards;
    }
    .splash-text-main{
      font-size:1.4rem;
      font-weight:800;
      letter-spacing:1px;
    }
    .splash-text-sub{
      font-size:0.95rem;
      margin-top:3px;
      opacity:0.9;
    }

    @keyframes splashFade{
      0%{opacity:0;}
      10%{opacity:1;}
      70%{opacity:1;}
      100%{opacity:0;}
    }
    @keyframes splashLogo{
      0%{transform:scale(0.7);opacity:0;}
      20%{transform:scale(1.05);opacity:1;}
      60%{transform:scale(1);opacity:1;}
      100%{transform:scale(0.9);opacity:0;}
    }

    /* CABECERA */
    .header{
      background:var(--card);
      border-radius:8px;
      padding:10px 12px;
      border:1px solid var(--borde);
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .header-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:44px;
      height:44px;
      border-radius:50%;
      background:var(--rojo);
      color:var(--amarillo);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:26px;
      box-shadow:0 3px 8px rgba(0,0,0,0.25);
    }
    .header-title{
      margin:0;
      font-size:1.3rem;
      font-weight:800;
      color:var(--rojo);
    }
    .header-sub{
      margin:2px 0 0;
      font-size:0.9rem;
      color:var(--texto-suave);
    }
    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    .chip{
      background:#ffe8e8;
      color:var(--rojo-osc);
      padding:3px 8px;
      border-radius:999px;
      font-size:0.8rem;
      font-weight:600;
    }
    .btn-reset{
      background:#ffffff;
      color:var(--rojo);
      border:2px solid var(--rojo);
      border-radius:999px;
      padding:5px 12px;
      font-size:0.9rem;
      font-weight:700;
      cursor:pointer;
    }
    .btn-reset:hover{
      background:#fff5f5;
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:4px;
      margin-bottom:8px;
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:4px;
    }
    .tab-btn{
      flex:1 1 0;
      border:none;
      background:transparent;
      padding:6px 8px;
      border-radius:6px;
      font-size:0.9rem;
      font-weight:600;
      color:var(--texto-suave);
      cursor:pointer;
    }
    .tab-btn.active{
      background:var(--rojo);
      color:#ffffff;
    }
    .tab-panel{
      display:none;
    }
    .tab-panel.active{
      display:block;
    }

    /* PASOS */
    .pasos{
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:8px 10px;
      margin-bottom:10px;
      font-size:0.9rem;
    }
    .pasos strong{
      color:var(--rojo-osc);
    }

    /* RESUMEN GENERAL */
    .resumen{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
    }
    .resumen-card{
      flex:1 1 155px;
      min-width:155px;
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:8px 10px;
    }
    .res-label{
      font-size:0.8rem;
      color:var(--texto-suave);
      text-transform:uppercase;
    }
    .res-value{
      font-size:1.5rem;
      font-weight:800;
    }

    /* FLETEROS */
    .fleteros-actions{
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:8px 10px;
      margin-bottom:10px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      font-size:0.85rem;
    }
    .fleteros-title{
      font-weight:700;
      color:var(--rojo-osc);
      margin-right:4px;
    }
    .btn-fletero{
      background:#ffffff;
      color:var(--rojo);
      border:1px solid var(--rojo);
      border-radius:999px;
      padding:4px 10px;
      font-size:0.8rem;
      font-weight:700;
      cursor:pointer;
    }
    .btn-fletero:hover{
      background:#fff5f5;
    }

    /* VUELTAS */
    .vueltas{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:10px;
    }
    .vuelta-card{
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:8px 10px;
    }
    .vuelta-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      cursor:pointer;
    }
    .vuelta-info{
      font-size:1rem;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .vuelta-nombre{
      color:var(--rojo);
      font-size:1.05rem;
    }
    .toggle-icon{
      font-size:0.9rem;
      width:14px;
      text-align:center;
      color:var(--texto-suave);
    }
    .vuelta-total{
      font-size:0.9rem;
      font-weight:700;
    }
    .vuelta-total span{
      color:var(--rojo-osc);
    }
    .vuelta-buttons{
      display:flex;
      flex-direction:column;
      gap:2px;
      align-items:flex-end;
      font-size:0.78rem;
      color:var(--texto-suave);
    }
    .vuelta-body{
      margin-top:4px;
    }
    .vuelta-card.collapsed .vuelta-body{
      display:none;
    }

    /* TABLAS */
    .tabla-wrap{
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.9rem;
    }
    th,td{
      padding:6px 7px;
      border-bottom:1px solid #e0e0e0;
      text-align:left;
      vertical-align:middle;
    }
    thead{
      background:#f9f9f9;
    }
    th{
      font-weight:700;
      color:#333333;
    }
    tbody tr:nth-child(even){
      background:#fafafa;
    }
    tbody tr.tiene{
      background:#fff9d6;
    }

    .col-taller{ min-width:180px; }
    .col-fletero{ width:130px; text-align:left; }
    .col-cant{ width:80px; text-align:center; }
    .col-obs{ min-width:200px; }

    .input-num{
      width:100%;
      max-width:80px;
      padding:5px 4px;
      font-size:0.95rem;
      text-align:right;
      border-radius:4px;
      border:1px solid #cccccc;
      height:32px;
    }
    .input-num:focus{
      border-color:var(--rojo);
      outline:none;
    }
    .input-text{
      width:100%;
      padding:5px 6px;
      font-size:0.95rem;
      border-radius:4px;
      border:1px solid #cccccc;
      height:32px;
    }
    .input-text:focus{
      border-color:var(--rojo);
      outline:none;
    }
    .select-fletero,
    .select-estado{
      width:100%;
      max-width:130px;
      padding:4px 3px;
      font-size:0.85rem;
      border-radius:4px;
      border:1px solid #cccccc;
      background:#ffffff;
      height:32px;
    }
    .select-fletero:focus,
    .select-estado:focus{
      border-color:var(--rojo);
      outline:none;
    }

    /* TAB ESTADO */
    .estado-info{
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:8px 10px;
      margin-bottom:8px;
      font-size:0.9rem;
      color:var(--texto-suave);
    }
    .estado-tag{
      font-weight:600;
    }

    .estado-resumen{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
    }
    .estado-res-card{
      flex:1 1 110px;
      min-width:110px;
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:6px 8px;
      font-size:0.85rem;
    }
    .estado-res-label{
      font-size:0.75rem;
      text-transform:uppercase;
      color:var(--texto-suave);
    }
    .estado-res-value{
      font-size:1.1rem;
      font-weight:700;
    }

    .estado-filtros{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
      font-size:0.85rem;
    }
    .estado-filtros label{
      font-weight:600;
      color:var(--texto-suave);
    }
    .estado-select{
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #d1d5db;
      background:#ffffff;
      font-size:0.85rem;
    }

    .estado-botones-masivo{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
      font-size:0.8rem;
    }
    .estado-btn-masivo{
      padding:4px 8px;
      border-radius:6px;
      border:1px solid var(--rojo);
      background:#ffffff;
      color:var(--rojo);
      cursor:pointer;
    }
    .estado-btn-masivo:hover{
      background:#fff5f5;
    }

    .estado-retiro{
      background:#fff9d6 !important;
    }
    .estado-proceso{
      background:#e0f2fe !important;
    }
    .estado-listo{
      background:#dcfce7 !important;
    }

    /* PANEL ORDEN / IMPRESIÓN */
    .orden-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9500;
    }
    .orden-card{
      width:100%;
      max-width:820px;
      max-height:90vh;
      background:#ffffff;
      border-radius:8px;
      border:1px solid #e5e7eb;
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      display:flex;
      flex-direction:column;
      padding:10px 12px;
    }
    .orden-header h2{
      margin:0 0 4px;
      font-size:1rem;
    }
    .orden-header p{
      margin:0;
      font-size:0.85rem;
      color:#6b7280;
    }
    .orden-table-wrap{
      flex:1 1 auto;
      overflow:auto;
      margin-top:6px;
    }
    .orden-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.85rem;
    }
    .orden-table th,
    .orden-table td{
      padding:4px 6px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      vertical-align:middle;
    }
    .orden-table thead{
      background:#f9fafb;
    }
    .orden-col-num{ width:32px; text-align:center; }
    .orden-col-vuelta{ width:70px; }
    .orden-col-cant{ width:70px; text-align:right; }
    .orden-col-acciones{ width:80px; text-align:center; }

    .orden-btn-small{
      padding:2px 6px;
      border-radius:4px;
      border:1px solid #d1d5db;
      background:#ffffff;
      font-size:0.7rem;
      cursor:pointer;
      margin:0 1px;
    }
    .orden-btn-small:hover{
      background:#f3f4f6;
    }

    .orden-footer{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .orden-btn-sec{
      padding:5px 10px;
      border-radius:4px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:#374151;
      font-size:0.8rem;
      font-weight:500;
      cursor:pointer;
    }
    .orden-btn-sec:hover{
      background:#f3f4f6;
    }
    .orden-btn-main{
      padding:5px 10px;
      border-radius:4px;
      border:1px solid var(--rojo);
      background:var(--rojo);
      color:#ffffff;
      font-size:0.8rem;
      font-weight:600;
      cursor:pointer;
    }
    .orden-btn-main:hover{
      background:#b91c1c;
    }

    /* IMPRESIÓN GRANDE A4 */
    @media print{
      @page{
        size:A4 portrait;
        margin:8mm;
      }

      body{
        background:#ffffff;
        font-size:20px;
      }

      .header,
      .tabs,
      .pasos,
      .resumen,
      .fleteros-actions,
      .vueltas,
      .estado-info,
      .estado-resumen,
      .estado-filtros,
      .estado-botones-masivo,
      .splash-overlay{
        display:none !important;
      }

      .orden-overlay{
        position:static;
        inset:auto;
        display:block !important;
        background:#ffffff !important;
      }

      .orden-card{
        box-shadow:none;
        border:none;
        width:100%;
        max-width:none;
        max-height:none;
        padding:10mm 10mm;
        min-height:80vh; /* ocupa casi toda la hoja */
      }

      .orden-header h2{
        font-size:26px;
        margin-bottom:10px;
      }

      .orden-header p{
        font-size:16px;
        margin-bottom:12px;
      }

      .orden-table th,
      .orden-table td{
        font-size:18px;
        padding:10px 12px;
      }

      .orden-footer{
        display:none;
      }
    }

    @media(max-width:720px){
      body{
        font-size:15px;
        padding:8px;
      }
      .header{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      .header-right{
        align-items:flex-start;
      }
      .header-title{
        font-size:1.1rem;
      }
      table{
        font-size:0.8rem;
      }
      th,td{
        padding:4px 5px;
      }
      .input-num,.input-text,.select-fletero,.select-estado{
        font-size:0.8rem;
        height:30px;
      }
      .col-fletero{
        width:110px;
      }
    }
  </style>
</head>
<body>
  <!-- SPLASH -->
  <div id="splash" class="splash-overlay">
    <div class="splash-logo-wrapper">
      <div class="splash-logo-circle">Q</div>
      <div class="splash-text-main">CRPC Quiroga</div>
      <div class="splash-text-sub">Retiro de cilindros</div>
    </div>
  </div>

  <div class="page">
    <!-- CABECERA -->
    <header class="header">
      <div class="header-left">
        <div class="logo">Q</div>
        <div>
          <h1 class="header-title">Retiro de cilindros por taller</h1>
          <p class="header-sub">Carga de talleres, fleteros y estado general.</p>
        </div>
      </div>
      <div class="header-right">
        <div class="chip">Uso interno CRPC</div>
        <button id="btn-reset" class="btn-reset">Reiniciar día</button>
      </div>
    </header>

    <!-- TABS -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="carga">Carga y reparto</button>
      <button class="tab-btn" data-tab="estado">Estado cilindros</button>
    </nav>

    <!-- TAB CARGA -->
    <section id="tab-carga" class="tab-panel active">
      <section class="pasos">
        <div><strong>PASO 1:</strong> Cargar cantidad de cilindros de cada taller.</div>
        <div><strong>PASO 2:</strong> Elegir fletero en cada taller (Agustín / Nano / Rodrigo / Joaquín).</div>
        <div><strong>PASO 3:</strong> Observaciones si hace falta.</div>
        <div><strong>PASO 4:</strong> En FLETEROS elegís el nombre, acomodás el orden con las flechas y desde ahí imprimís.</div>
      </section>

      <section class="resumen">
        <div class="resumen-card">
          <div class="res-label">Cilindros totales</div>
          <div class="res-value" id="cil-total-general">0</div>
        </div>
        <div class="resumen-card">
          <div class="res-label">Vuelta 1</div>
          <div class="res-value" id="cil-v1">0</div>
        </div>
        <div class="resumen-card">
          <div class="res-label">Vuelta 2</div>
          <div class="res-value" id="cil-v2">0</div>
        </div>
        <div class="resumen-card">
          <div class="res-label">Vuelta 3</div>
          <div class="res-value" id="cil-v3">0</div>
        </div>
      </section>

      <section class="fleteros-actions">
        <span class="fleteros-title">Fleteros</span>
        <button class="btn-fletero btn-print-fletero" data-fletero="Agustin">Orden / Imprimir Agustín</button>
        <button class="btn-fletero btn-print-fletero" data-fletero="Nano">Orden / Imprimir Nano</button>
        <button class="btn-fletero btn-print-fletero" data-fletero="Rodrigo">Orden / Imprimir Rodrigo</button>
        <button class="btn-fletero btn-print-fletero" data-fletero="Joaquin">Orden / Imprimir Joaquín</button>
      </section>

      <section class="vueltas">
        <!-- V1 -->
        <article class="vuelta-card" data-vuelta="1">
          <div class="vuelta-header">
            <div class="vuelta-info">
              <span class="toggle-icon">▼</span>
              <span class="vuelta-nombre">Vuelta 1</span>
            </div>
            <div class="vuelta-buttons">
              <div class="vuelta-total">Cilindros: <span id="cil-v1-card">0</span></div>
            </div>
          </div>
          <div class="vuelta-body">
            <div class="tabla-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="col-taller">Taller</th>
                    <th class="col-fletero">Fletero</th>
                    <th class="col-cant">Cantidad</th>
                    <th class="col-obs">Observaciones</th>
                  </tr>
                </thead>
                <tbody id="tbody-v1"></tbody>
              </table>
            </div>
          </div>
        </article>

        <!-- V2 -->
        <article class="vuelta-card" data-vuelta="2">
          <div class="vuelta-header">
            <div class="vuelta-info">
              <span class="toggle-icon">▼</span>
              <span class="vuelta-nombre">Vuelta 2</span>
            </div>
            <div class="vuelta-buttons">
              <div class="vuelta-total">Cilindros: <span id="cil-v2-card">0</span></div>
            </div>
          </div>
          <div class="vuelta-body">
            <div class="tabla-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="col-taller">Taller</th>
                    <th class="col-fletero">Fletero</th>
                    <th class="col-cant">Cantidad</th>
                    <th class="col-obs">Observaciones</th>
                  </tr>
                </thead>
                <tbody id="tbody-v2"></tbody>
              </table>
            </div>
          </div>
        </article>

        <!-- V3 -->
        <article class="vuelta-card" data-vuelta="3">
          <div class="vuelta-header">
            <div class="vuelta-info">
              <span class="toggle-icon">▼</span>
              <span class="vuelta-nombre">Vuelta 3</span>
            </div>
            <div class="vuelta-buttons">
              <div class="vuelta-total">Cilindros: <span id="cil-v3-card">0</span></div>
            </div>
          </div>
          <div class="vuelta-body">
            <div class="tabla-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="col-taller">Taller</th>
                    <th class="col-fletero">Fletero</th>
                    <th class="col-cant">Cantidad</th>
                    <th class="col-obs">Observaciones</th>
                  </tr>
                </thead>
                <tbody id="tbody-v3"></tbody>
              </table>
            </div>
          </div>
        </article>
      </section>
    </section>

    <!-- TAB ESTADO -->
    <section id="tab-estado" class="tab-panel">
      <section class="estado-info">
        Solo aparecen talleres con cilindros cargados (cantidad &gt; 0).
        <br>
        <span class="estado-tag">• En retiro:</span> cilindros todavía en taller / en viaje.
        <br>
        <span class="estado-tag">• Proceso:</span> cilindros en CRPC (prueba, armado, etc.).
        <br>
        <span class="estado-tag">• Listo:</span> cilindros terminados para entregar.
      </section>

      <section class="estado-resumen">
        <div class="estado-res-card">
          <div class="estado-res-label">En retiro</div>
          <div class="estado-res-value" id="estado-retiro-count">0</div>
        </div>
        <div class="estado-res-card">
          <div class="estado-res-label">Proceso</div>
          <div class="estado-res-value" id="estado-proceso-count">0</div>
        </div>
        <div class="estado-res-card">
          <div class="estado-res-label">Listo</div>
          <div class="estado-res-value" id="estado-listo-count">0</div>
        </div>
      </section>

      <section class="estado-filtros">
        <label for="estado-filtro-fletero">Fletero:</label>
        <select id="estado-filtro-fletero" class="estado-select">
          <option value="todos">Todos</option>
          <option value="Agustin">Agustín</option>
          <option value="Nano">Nano</option>
          <option value="Rodrigo">Rodrigo</option>
          <option value="Joaquin">Joaquín</option>
        </select>
        <span style="font-size:0.8rem;color:var(--texto-suave);">El filtro afecta la tabla y el resumen.</span>
      </section>

      <section class="estado-botones-masivo">
        <button id="btn-estado-todos-proceso" class="estado-btn-masivo">Pasar todos a Proceso</button>
        <button id="btn-estado-todos-listo" class="estado-btn-masivo">Pasar todos a Listo</button>
      </section>

      <div class="tabla-wrap">
        <table>
          <thead>
            <tr>
              <th>Taller</th>
              <th>Vuelta</th>
              <th>Cant.</th>
              <th>Fletero</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tbody-estado"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- PANEL ORDEN / IMPRESIÓN -->
  <div id="orden-overlay" class="orden-overlay">
    <div class="orden-card">
      <div class="orden-header">
        <h2>Orden de talleres – Fletero <span id="orden-fletero-nombre"></span></h2>
        <p>Usá las flechas para acomodar el recorrido. Después imprimís esta lista (incluye observaciones).</p>
      </div>
      <div class="orden-table-wrap">
        <table class="orden-table">
          <thead>
            <tr>
              <th class="orden-col-num">#</th>
              <th class="orden-col-vuelta">Vuelta</th>
              <th>Taller</th>
              <th class="orden-col-cant">PHS</th>
              <th>Observaciones</th>
              <th class="orden-col-acciones">Orden</th>
            </tr>
          </thead>
          <tbody id="orden-tbody"></tbody>
        </table>
      </div>
      <div class="orden-footer">
        <button id="orden-cerrar" class="orden-btn-sec">Cerrar</button>
        <button id="orden-imprimir" class="orden-btn-main">Imprimir</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDocs,
      onSnapshot,
      setDoc,
      updateDoc,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7p0rPT0sB4RGOqgHOu8gjdC8hcjuMO-8",
      authDomain: "crpc-cilindros.firebaseapp.com",
      projectId: "crpc-cilindros",
      storageBucket: "crpc-cilindros.firebasestorage.app",
      messagingSenderId: "6730395812",
      appId: "1:6730395812:web:327d3f031e05fdbd33f631",
      measurementId: "G-7FEQWXK5VB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colTalleres = collection(db, "talleres_reparto");

    const splashEl = document.getElementById("splash");
    if(splashEl){
      splashEl.addEventListener("animationend", () => {
        splashEl.style.display = "none";
      });
    }

    const ordenManual = {
      "minuto-gnc":1,
      "silvana-calera":2,
      "calera-torres-gnc":3,
      "zico":4,
      "colon-gnc":5,
      "tabach-gnc":6,
      "franco-alta-gracia":7,
      "servincor":8,
      "bruno-f":9,
      "porto-alta-gracia":10,
      "brochero-gnc":11,
      "valparaiso-gnc":12,
      "canovas":13,
      "malvinas-gnc":14,
      "genesis-gnc":15,
      "alem":16,
      "cars":17,
      "forteza-gnc":18,
      "enero-gas":19,
      "pepe":20,
      "san-francisco-gnc":21,
      "genovesio":22,
      "gnc-giordano":23,
      "tecno-gnc":24,
      "marcos-gnc":25,
      "franco-cba":26,
      "franc-villa-dolores":27,
      "leal":28,
      "misiti":29,
      "enjom":30,
      "alemanes":31,
      "acosta":32,
      "ceriani":33
    };

    const defaultTalleres = [
      { id: "minuto-gnc", nombre: "Minuto GNC", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "calera-torres-gnc", nombre: "Calera Torres", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "silvana-calera", nombre: "Calera Silvana", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "zico", nombre: "Zico", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "colon-gnc", nombre: "Colón GNC", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "tabach-gnc", nombre: "Tabach GNC", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "franco-alta-gracia", nombre: "Franco Alta Gracia", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "servincor", nombre: "Servincor", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "bruno-f", nombre: "Bruno F", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "porto-alta-gracia", nombre: "Porto Alta Gracia", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "brochero-gnc", nombre: "Brochero GNC", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "valparaiso-gnc", nombre: "Valparaíso GNC", vuelta: 1, cantidad: 0, obs: "", fletero:"", estado:"retiro" },

      { id: "canovas", nombre: "Cánovas", vuelta: 2, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "malvinas-gnc", nombre: "Malvinas GNC", vuelta: 2, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "genesis-gnc", nombre: "Génesis GNC", vuelta: 2, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "alem", nombre: "ALEM", vuelta: 2, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "cars", nombre: "Cars", vuelta: 2, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "forteza-gnc", nombre: "Forteza GNC", vuelta: 2, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "enero-gas", nombre: "Enero Gas", vuelta: 2, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "pepe", nombre: "Pepe", vuelta: 2, cantidad: 0, obs: "", fletero:"", estado:"retiro" },

      { id: "san-francisco-gnc", nombre: "San Francisco GNC", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "genovesio", nombre: "Genovesio", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "gnc-giordano", nombre: "GNC Giordano", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "tecno-gnc", nombre: "Tecno GNC", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "marcos-gnc", nombre: "Marcos GNC", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "franco-cba", nombre: "Franco cba", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "franc-villa-dolores", nombre: "Franc Villa Dolores", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "leal", nombre: "Leal", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "misiti", nombre: "Misiti", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "enjom", nombre: "Enjom", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "alemanes", nombre: "Alemanes", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "acosta", nombre: "Rosso", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" },
      { id: "ceriani", nombre: "CERIANI", vuelta: 3, cantidad: 0, obs: "", fletero:"", estado:"retiro" }
    ];

    const tbodyV1 = document.getElementById("tbody-v1");
    const tbodyV2 = document.getElementById("tbody-v2");
    const tbodyV3 = document.getElementById("tbody-v3");
    const tbodyEstado = document.getElementById("tbody-estado");

    const cilTotalGeneralEl = document.getElementById("cil-total-general");
    const cilV1ResumenEl = document.getElementById("cil-v1");
    const cilV2ResumenEl = document.getElementById("cil-v2");
    const cilV3ResumenEl = document.getElementById("cil-v3");

    const cilV1CardEl = document.getElementById("cil-v1-card");
    const cilV2CardEl = document.getElementById("cil-v2-card");
    const cilV3CardEl = document.getElementById("cil-v3-card");

    const btnReset = document.getElementById("btn-reset");

    const estadoRetiroCountEl = document.getElementById("estado-retiro-count");
    const estadoProcesoCountEl = document.getElementById("estado-proceso-count");
    const estadoListoCountEl = document.getElementById("estado-listo-count");
    const estadoFiltroFletero = document.getElementById("estado-filtro-fletero");
    const btnEstadoTodosProceso = document.getElementById("btn-estado-todos-proceso");
    const btnEstadoTodosListo = document.getElementById("btn-estado-todos-listo");

    const ordenOverlay = document.getElementById("orden-overlay");
    const ordenFleteroNombreEl = document.getElementById("orden-fletero-nombre");
    const ordenTbodyEl = document.getElementById("orden-tbody");
    const ordenCerrarBtn = document.getElementById("orden-cerrar");
    const ordenImprimirBtn = document.getElementById("orden-imprimir");

    let talleres = [];
    let panelItems = [];
    let filtroFletero = "todos";

    async function actualizarCantidad(id, valor){
      let n = parseInt(valor, 10);
      if(isNaN(n) || n < 0) n = 0;
      const ref = doc(colTalleres, id);
      await updateDoc(ref, { cantidad: n });
    }

    async function actualizarObs(id, texto){
      const ref = doc(colTalleres, id);
      await updateDoc(ref, { obs: texto });
    }

    async function actualizarFletero(id, fletero){
      const ref = doc(colTalleres, id);
      await updateDoc(ref, { fletero: fletero });
    }

    async function actualizarEstado(id, estado){
      const ref = doc(colTalleres, id);
      await updateDoc(ref, { estado: estado });
    }

    async function reiniciarDia(){
      const ok = confirm("¿Reiniciar TODOS los datos de hoy? (cantidades, fletero, observaciones, estado)?");
      if(!ok) return;
      const snap = await getDocs(colTalleres);
      const batch = writeBatch(db);
      snap.forEach(d => {
        batch.update(d.ref, {
          cantidad: 0,
          obs: "",
          fletero: "",
          estado: "retiro"
        });
      });
      await batch.commit();
    }

    function renderVuelta(vuelta, tbody){
      tbody.innerHTML = "";
      const lista = talleres
        .filter(t => t.vuelta === vuelta)
        .sort((a,b) => {
          const oa = ordenManual[a.id] ?? 9999;
          const ob = ordenManual[b.id] ?? 9999;
          if(oa !== ob) return oa - ob;
          return a.nombre.localeCompare(b.nombre,"es");
        });

      lista.forEach(t => {
        const cant = Number(t.cantidad) || 0;
        const fleteroVal = t.fletero || "";

        const tr = document.createElement("tr");
        tr.dataset.id = t.id;
        if(cant > 0) tr.classList.add("tiene");

        const tdTaller = document.createElement("td");
        tdTaller.className = "col-taller";
        const nombreSpan = document.createElement("span");
        nombreSpan.textContent = t.nombre;
        tdTaller.appendChild(nombreSpan);
        tr.appendChild(tdTaller);

        const tdFlet = document.createElement("td");
        tdFlet.className = "col-fletero";
        const selF = document.createElement("select");
        selF.className = "select-fletero";
        selF.innerHTML = `
          <option value="">-</option>
          <option value="Agustin">Agustín</option>
          <option value="Nano">Nano</option>
          <option value="Rodrigo">Rodrigo</option>
          <option value="Joaquin">Joaquín</option>
        `;
        selF.value = fleteroVal || "";
        tdFlet.appendChild(selF);
        tr.appendChild(tdFlet);

        const tdCant = document.createElement("td");
        tdCant.className = "col-cant";
        const inpCant = document.createElement("input");
        inpCant.type = "number";
        inpCant.min = "0";
        inpCant.step = "1";
        inpCant.className = "input-num";
        inpCant.value = cant > 0 ? cant : "";
        tdCant.appendChild(inpCant);
        tr.appendChild(tdCant);

        const tdObs = document.createElement("td");
        tdObs.className = "col-obs";
        const inpObs = document.createElement("input");
        inpObs.type = "text";
        inpObs.className = "input-text";
        inpObs.value = t.obs || "";
        tdObs.appendChild(inpObs);
        tr.appendChild(tdObs);

        selF.addEventListener("change", () => {
          actualizarFletero(t.id, selF.value);
        });

        inpCant.addEventListener("blur", () => {
          actualizarCantidad(t.id, inpCant.value);
        });
        inpCant.addEventListener("keydown", (e) => {
          if(e.key === "Enter") inpCant.blur();
        });

        inpObs.addEventListener("blur", () => {
          actualizarObs(t.id, inpObs.value.trim());
        });

        tbody.appendChild(tr);
      });
    }

    function pesoEstado(e){
      const x = (e || "retiro").toLowerCase();
      if(x === "retiro") return 1;
      if(x === "proceso") return 2;
      if(x === "listo") return 3;
      return 4;
    }

    function renderEstado(){
      if(!tbodyEstado) return;
      tbodyEstado.innerHTML = "";

      let lista = talleres.filter(t => (Number(t.cantidad) || 0) > 0);

      if(filtroFletero !== "todos"){
        lista = lista.filter(t => (t.fletero || "") === filtroFletero);
      }

      lista.sort((a,b) => {
        const ea = a.estado || "retiro";
        const eb = b.estado || "retiro";
        const pa = pesoEstado(ea);
        const pb = pesoEstado(eb);
        if(pa !== pb) return pa - pb;
        if(a.vuelta !== b.vuelta) return a.vuelta - b.vuelta;
        const oa = ordenManual[a.id] ?? 9999;
        const ob = ordenManual[b.id] ?? 9999;
        if(oa !== ob) return oa - ob;
        return a.nombre.localeCompare(b.nombre,"es");
      });

      let retiroCount = 0, procesoCount = 0, listoCount = 0;
      lista.forEach(t => {
        const c = Number(t.cantidad) || 0;
        const e = (t.estado || "retiro").toLowerCase();
        if(e === "proceso") procesoCount += c;
        else if(e === "listo") listoCount += c;
        else retiroCount += c;
      });

      if(estadoRetiroCountEl) estadoRetiroCountEl.textContent = retiroCount;
      if(estadoProcesoCountEl) estadoProcesoCountEl.textContent = procesoCount;
      if(estadoListoCountEl) estadoListoCountEl.textContent = listoCount;

      lista.forEach(t => {
        const c = Number(t.cantidad) || 0;
        const fle = t.fletero || "";
        const estadoVal = (t.estado || "retiro").toLowerCase();

        const tr = document.createElement("tr");
        if(estadoVal === "proceso") tr.classList.add("estado-proceso");
        else if(estadoVal === "listo") tr.classList.add("estado-listo");
        else tr.classList.add("estado-retiro");

        const tdTaller = document.createElement("td");
        tdTaller.textContent = t.nombre;
        tr.appendChild(tdTaller);

        const tdVuelta = document.createElement("td");
        tdVuelta.textContent = "V" + (t.vuelta || "?");
        tr.appendChild(tdVuelta);

        const tdCant = document.createElement("td");
        tdCant.textContent = c;
        tr.appendChild(tdCant);

        const tdFle = document.createElement("td");
        tdFle.textContent = fle || "-";
        tr.appendChild(tdFle);

        const tdEstado = document.createElement("td");
        const selEstado = document.createElement("select");
        selEstado.className = "select-estado";
        selEstado.innerHTML = `
          <option value="retiro">En retiro</option>
          <option value="proceso">Proceso</option>
          <option value="listo">Listo</option>
        `;
        selEstado.value = estadoVal;
        selEstado.addEventListener("change", () => {
          actualizarEstado(t.id, selEstado.value);
        });
        tdEstado.appendChild(selEstado);
        tr.appendChild(tdEstado);

        tbodyEstado.appendChild(tr);
      });
    }

    function render(){
      renderVuelta(1, tbodyV1);
      renderVuelta(2, tbodyV2);
      renderVuelta(3, tbodyV3);
      renderEstado();

      let total = 0, v1 = 0, v2 = 0, v3 = 0;

      talleres.forEach(t => {
        const c = Number(t.cantidad) || 0;
        total += c;
        if(t.vuelta === 1) v1 += c;
        else if(t.vuelta === 2) v2 += c;
        else if(t.vuelta === 3) v3 += c;
      });

      cilTotalGeneralEl.textContent = total;
      cilV1ResumenEl.textContent = v1;
      cilV2ResumenEl.textContent = v2;
      cilV3ResumenEl.textContent = v3;

      cilV1CardEl.textContent = v1;
      cilV2CardEl.textContent = v2;
      cilV3CardEl.textContent = v3;
    }

    async function cambiarEstadoMasivo(nuevoEstado){
      const candidatos = talleres.filter(t => {
        const c = Number(t.cantidad) || 0;
        if(c <= 0) return false;
        if(filtroFletero === "todos") return true;
        return (t.fletero || "") === filtroFletero;
      });

      if(candidatos.length === 0){
        alert("No hay talleres con cilindros para actualizar en este filtro.");
        return;
      }

      const ok = confirm(`Pasar ${candidatos.length} taller(es) a estado "${nuevoEstado.toUpperCase()}"?`);
      if(!ok) return;

      const batch = writeBatch(db);
      candidatos.forEach(t => {
        const ref = doc(colTalleres, t.id);
        batch.update(ref, { estado: nuevoEstado });
      });
      await batch.commit();
    }

    /* PANEL ORDEN – toma cantidad y observaciones aunque no estén guardadas,
       e incluye talleres con cantidad > 0 o con observaciones llenas */
    function renderOrdenPanel(){
      ordenTbodyEl.innerHTML = "";
      panelItems.forEach((item, idx) => {
        const tr = document.createElement("tr");

        const tdNum = document.createElement("td");
        tdNum.className = "orden-col-num";
        tdNum.textContent = idx + 1;
        tr.appendChild(tdNum);

        const tdVuelta = document.createElement("td");
        tdVuelta.className = "orden-col-vuelta";
        tdVuelta.textContent = "V" + (item.vuelta || "?");
        tr.appendChild(tdVuelta);

        const tdTaller = document.createElement("td");
        tdTaller.textContent = item.taller || "";
        tr.appendChild(tdTaller);

        const tdCant = document.createElement("td");
        tdCant.className = "orden-col-cant";
        tdCant.textContent = item.cantidad || item.cantidad === 0 ? item.cantidad : "";
        tr.appendChild(tdCant);

        const tdObs = document.createElement("td");
        tdObs.textContent = item.obs || "";
        tr.appendChild(tdObs);

        const tdAcc = document.createElement("td");
        tdAcc.className = "orden-col-acciones";
        const btnUp = document.createElement("button");
        btnUp.textContent = "↑";
        btnUp.className = "orden-btn-small";
        btnUp.addEventListener("click", () => moverOrden(idx, -1));
        const btnDown = document.createElement("button");
        btnDown.textContent = "↓";
        btnDown.className = "orden-btn-small";
        btnDown.addEventListener("click", () => moverOrden(idx, 1));
        tdAcc.appendChild(btnUp);
        tdAcc.appendChild(btnDown);
        tr.appendChild(tdAcc);

        ordenTbodyEl.appendChild(tr);
      });
    }

    function moverOrden(index, dir){
      const nuevo = index + dir;
      if(nuevo < 0 || nuevo >= panelItems.length) return;
      const temp = panelItems[index];
      panelItems[index] = panelItems[nuevo];
      panelItems[nuevo] = temp;
      renderOrdenPanel();
    }

    function abrirOrdenFletero(fleteroClave){
      const fleLower = fleteroClave.toLowerCase();
      const candidatos = talleres.filter(t => (t.fletero || "").toLowerCase() === fleLower);

      const seleccion = [];
      candidatos.forEach(t => {
        let cantidad = Number(t.cantidad) || 0;
        let obs = t.obs || "";

        const fila = document.querySelector('tr[data-id="' + t.id + '"]');
        if(fila){
          const inpCant = fila.querySelector('.input-num');
          const inpObs = fila.querySelector('.input-text');
          if(inpCant){
            const v = parseInt(inpCant.value, 10);
            if(!isNaN(v) && v >= 0) cantidad = v;
          }
          if(inpObs){
            obs = inpObs.value || "";
          }
        }

        // INCLUIR SI:
        // - tiene cilindros (>0) O
        // - no tiene cilindros pero tiene observaciones cargadas
        if(cantidad > 0 || (obs && obs.trim() !== "")){
          seleccion.push({
            taller: t.nombre,
            vuelta: t.vuelta,
            cantidad,
            obs
          });
        }
      });

      if(seleccion.length === 0){
        alert("No hay talleres asignados a " + fleteroClave + " con cilindros u observaciones para imprimir.");
        return;
      }

      panelItems = seleccion;
      ordenFleteroNombreEl.textContent = fleteroClave;
      renderOrdenPanel();

      ordenOverlay.style.display = "flex";
      document.body.classList.add("orden-open");
    }

    function cerrarOrden(){
      ordenOverlay.style.display = "none";
      document.body.classList.remove("orden-open");
    }

    function initBotonesFletero(){
      const botones = document.querySelectorAll(".btn-print-fletero");
      botones.forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          const fle = btn.getAttribute("data-fletero");
          if(!fle) return;
          abrirOrdenFletero(fle);
        });
      });
    }

    function initCollapsibles(){
      const cards = document.querySelectorAll(".vuelta-card");
      cards.forEach(card => {
        const header = card.querySelector(".vuelta-header");
        const icon = card.querySelector(".toggle-icon");
        if(!header) return;

        header.addEventListener("click", (e) => {
          if(e.target.closest("button")) return;
          const isCollapsed = card.classList.toggle("collapsed");
          if(icon) icon.textContent = isCollapsed ? "►" : "▼";
        });
      });
    }

    function initTabs(){
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabPanels = document.querySelectorAll(".tab-panel");

      tabButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          tabButtons.forEach(b => b.classList.toggle("active", b === btn));
          tabPanels.forEach(p => {
            const id = "tab-" + tab;
            p.classList.toggle("active", p.id === id);
          });
        });
      });
    }

    async function inicializarDatos(){
      const snap = await getDocs(colTalleres);
      if(snap.empty){
        for(const t of defaultTalleres){
          await setDoc(doc(colTalleres, t.id), t);
        }
      }

      onSnapshot(colTalleres, snap2 => {
        const arr = [];
        snap2.forEach(d => {
          const data = d.data();
          let nombre = data.nombre || "";
          if(d.id === "acosta") nombre = "Rosso";
          if(d.id === "silvana-calera") nombre = "Calera Silvana";
          if(d.id === "calera-torres-gnc") nombre = "Calera Torres";

          const fleFallback =
            data.fletero ||
            (data.asignAgustin ? "Agustin" :
             data.asignNano ? "Nano" :
             data.asignRodrigo ? "Rodrigo" :
             data.asignJoaquin ? "Joaquin" : "");

          arr.push({
            id: d.id,
            nombre,
            vuelta: data.vuelta ?? 1,
            cantidad: data.cantidad ?? 0,
            obs: data.obs || "",
            fletero: fleFallback || "",
            estado: data.estado || "retiro"
          });
        });
        talleres = arr;
        render();
      });

      if(btnReset) btnReset.addEventListener("click", reiniciarDia);
      if(ordenCerrarBtn) ordenCerrarBtn.addEventListener("click", cerrarOrden);
      if(ordenImprimirBtn) ordenImprimirBtn.addEventListener("click", () => {
        window.print();
      });

      if(estadoFiltroFletero){
        estadoFiltroFletero.addEventListener("change", () => {
          filtroFletero = estadoFiltroFletero.value;
          renderEstado();
        });
      }

      if(btnEstadoTodosProceso){
        btnEstadoTodosProceso.addEventListener("click", () => {
          cambiarEstadoMasivo("proceso");
        });
      }
      if(btnEstadoTodosListo){
        btnEstadoTodosListo.addEventListener("click", () => {
          cambiarEstadoMasivo("listo");
        });
      }

      initBotonesFletero();
      initCollapsibles();
      initTabs();
    }

    inicializarDatos();
  </script>
</body>
</html>
