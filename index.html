<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CRPC Quiroga – Retiro de cilindros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --rojo:#d50000;
      --rojo-osc:#a80000;
      --amarillo:#ffd600;
      --fondo:#f4f4f4;
      --card:#ffffff;
      --borde:#dddddd;
      --texto:#111111;
      --texto-suave:#555555;
    }

    *{
      box-sizing:border-box;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      margin:0;
      padding:10px;
      background:var(--fondo);
      color:var(--texto);
      font-size:16px;
    }

    .page{
      max-width:1100px;
      margin:0 auto;
    }

    /* SPLASH / ANIMACIÓN LOGO */
    .splash-overlay{
      position:fixed;
      inset:0;
      background:var(--rojo);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      animation:splashFade 2.7s ease-in-out forwards;
    }
    .splash-logo-wrapper{
      text-align:center;
      color:#ffffff;
    }
    .splash-logo-circle{
      width:96px;
      height:96px;
      border-radius:50%;
      border:4px solid var(--amarillo);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:56px;
      font-weight:900;
      color:var(--amarillo);
      box-shadow:0 6px 18px rgba(0,0,0,0.4);
      margin:0 auto 12px;
      background:rgba(0,0,0,0.15);
      animation:splashLogo 2.7s ease-in-out forwards;
    }
    .splash-text-main{
      font-size:1.4rem;
      font-weight:800;
      letter-spacing:1px;
    }
    .splash-text-sub{
      font-size:0.95rem;
      margin-top:3px;
      opacity:0.9;
    }

    @keyframes splashFade{
      0%{opacity:0;}
      10%{opacity:1;}
      70%{opacity:1;}
      100%{opacity:0;}
    }
    @keyframes splashLogo{
      0%{transform:scale(0.7);opacity:0;}
      20%{transform:scale(1.05);opacity:1;}
      60%{transform:scale(1);opacity:1;}
      100%{transform:scale(0.9);opacity:0;}
    }

    /* CABECERA */
    .header{
      background:var(--card);
      border-radius:8px;
      padding:10px 12px;
      border:1px solid var(--borde);
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .header-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:44px;
      height:44px;
      border-radius:50%;
      background:var(--rojo);
      color:var(--amarillo);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:26px;
      box-shadow:0 3px 8px rgba(0,0,0,0.25);
    }
    .header-title{
      margin:0;
      font-size:1.3rem;
      font-weight:800;
      color:var(--rojo);
    }
    .header-sub{
      margin:2px 0 0;
      font-size:0.9rem;
      color:var(--texto-suave);
    }
    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    .chip{
      background:#ffe8e8;
      color:var(--rojo-osc);
      padding:3px 8px;
      border-radius:999px;
      font-size:0.8rem;
      font-weight:600;
    }
    .btn-reset{
      background:#ffffff;
      color:var(--rojo);
      border:2px solid var(--rojo);
      border-radius:999px;
      padding:5px 12px;
      font-size:0.9rem;
      font-weight:700;
      cursor:pointer;
    }
    .btn-reset:hover{
      background:#fff5f5;
    }

    /* PASOS */
    .pasos{
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:8px 10px;
      margin-bottom:10px;
      font-size:0.9rem;
    }
    .pasos strong{
      color:var(--rojo-osc);
    }

    /* RESUMEN */
    .resumen{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:10px;
    }
    .resumen-card{
      flex:1 1 160px;
      min-width:160px;
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:8px 10px;
    }
    .res-label{
      font-size:0.8rem;
      color:var(--texto-suave);
      text-transform:uppercase;
    }
    .res-value{
      font-size:1.6rem;
      font-weight:800;
    }

    /* VUELTAS */
    .vueltas{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:10px;
    }
    .vuelta-card{
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--borde);
      padding:8px 10px;
    }
    .vuelta-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      cursor:pointer;
    }
    .vuelta-info{
      font-size:1rem;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .vuelta-nombre{
      color:var(--rojo);
      font-size:1.05rem;
    }
    .toggle-icon{
      font-size:0.9rem;
      width:14px;
      text-align:center;
      color:var(--texto-suave);
    }

    .vuelta-total{
      font-size:0.9rem;
      font-weight:700;
    }
    .vuelta-total span{
      color:var(--rojo-osc);
    }

    .vuelta-buttons{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:flex-end;
    }
    .btn-sec{
      background:#ffffff;
      color:var(--rojo);
      border:1px solid var(--rojo);
      border-radius:999px;
      padding:3px 10px;
      font-size:0.8rem;
      font-weight:700;
      cursor:pointer;
    }
    .btn-sec:hover{
      background:#fff5f5;
    }

    .vuelta-body{
      margin-top:4px;
    }
    .vuelta-card.collapsed .vuelta-body{
      display:none;
    }

    /* Selección rápida */
    .vuelta-select-row{
      margin-bottom:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      font-size:0.8rem;
      color:var(--texto-suave);
    }
    .vuelta-select-label{
      font-weight:600;
    }
    .btn-mini{
      background:#ffffff;
      border:1px solid var(--borde);
      border-radius:999px;
      padding:2px 8px;
      font-size:0.75rem;
      cursor:pointer;
    }
    .btn-mini:hover{
      border-color:var(--rojo);
      color:var(--rojo);
    }

    /* TABLA */
    .tabla-wrap{
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.9rem;
    }
    th,td{
      padding:6px 7px;
      border-bottom:1px solid #e0e0e0;
      text-align:left;
      vertical-align:middle;
    }
    thead{
      background:#f9f9f9;
    }
    th{
      font-weight:700;
      color:#333333;
    }
    tbody tr:nth-child(even){
      background:#fafafa;
    }
    tbody tr.tiene{
      background:#fff9d6;
    }

    .col-taller{ min-width:190px; }
    .col-tiene{ width:75px; text-align:center; }
    .col-wsp{ width:75px; text-align:center; }
    .col-cant{ width:95px; text-align:center; }
    .col-obs{ min-width:220px; }

    input[type="checkbox"]{
      transform:scale(1.3);
      cursor:pointer;
    }
    .input-num{
      width:100%;
      max-width:80px;
      padding:5px 4px;
      font-size:0.95rem;
      text-align:right;
      border-radius:4px;
      border:1px solid #cccccc;
      height:32px;
    }
    .input-num:focus{
      border-color:var(--rojo);
      outline:none;
    }
    .input-text{
      width:100%;
      padding:5px 6px;
      font-size:0.95rem;
      border-radius:4px;
      border:1px solid #cccccc;
      height:32px;
    }
    .input-text:focus{
      border-color:var(--rojo);
      outline:none;
    }

    .print-hidden{
      display:none !important;
    }

    @media print{
      body{
        background:#ffffff;
        font-size:14px;
      }
      .header,
      .pasos,
      .resumen,
      .btn-sec,
      .btn-reset,
      .btn-mini{
        display:none !重要;
      }
      .splash-overlay{
        display:none !important;
      }
      /* Ocultar columnas de check en papel */
      .col-tiene,
      .col-wsp{
        display:none;
      }
    }

    @media(max-width:720px){
      body{
        font-size:15px;
        padding:8px;
      }
      .header{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      .header-right{
        align-items:flex-start;
      }
      .header-title{
        font-size:1.1rem;
      }
      table{
        font-size:0.82rem;
      }
      th,td{
        padding:4px 5px;
      }
      .input-num,.input-text{
        font-size:0.85rem;
        height:30px;
      }
    }
  </style>
</head>
<body>
  <!-- ANIMACIÓN LOGO -->
  <div id="splash" class="splash-overlay">
    <div class="splash-logo-wrapper">
      <div class="splash-logo-circle">Q</div>
      <div class="splash-text-main">CRPC Quiroga</div>
      <div class="splash-text-sub">Retiro de cilindros</div>
    </div>
  </div>

  <div class="page">
    <!-- CABECERA -->
    <header class="header">
      <div class="header-left">
        <div class="logo">Q</div>
        <div>
          <h1 class="header-title">Retiro de cilindros por taller</h1>
          <p class="header-sub">Cargar cilindros, separar por vuelta y mandar ruta al fletero.</p>
        </div>
      </div>
      <div class="header-right">
        <div class="chip">Uso interno CRPC</div>
        <button id="btn-reset" class="btn-reset">Reiniciar día</button>
      </div>
    </header>

    <!-- PASOS -->
    <section class="pasos">
      <div><strong>PASO 1:</strong> Anotar cantidad. “TIENE” queda activo y se guarda (sirve para imprimir).</div>
      <div><strong>PASO 2:</strong> Marcar “WSP” en los talleres que querés mandar por WhatsApp (pueden ser de cualquier vuelta).</div>
      <div><strong>PASO 3:</strong> Botón “WhatsApp / Imprimir”: arma UN solo mensaje con TODOS los WSP marcados. “Imprimir vuelta” usa TIENE de esa vuelta.</div>
    </section>

    <!-- RESUMEN -->
    <section class="resumen">
      <div class="resumen-card">
        <div class="res-label">Cilindros totales</div>
        <div class="res-value" id="cil-total-general">0</div>
      </div>
      <div class="resumen-card">
        <div class="res-label">Vuelta 1</div>
        <div class="res-value" id="cil-v1">0</div>
      </div>
      <div class="resumen-card">
        <div class="res-label">Vuelta 2</div>
        <div class="res-value" id="cil-v2">0</div>
      </div>
      <div class="resumen-card">
        <div class="res-label">Vuelta 3</div>
        <div class="res-value" id="cil-v3">0</div>
      </div>
    </section>

    <!-- VUELTAS -->
    <section class="vueltas">
      <!-- VUELTA 1 -->
      <article class="vuelta-card" data-vuelta="1">
        <div class="vuelta-header">
          <div class="vuelta-info">
            <span class="toggle-icon">▼</span>
            <span class="vuelta-nombre">Vuelta 1</span>
          </div>
          <div class="vuelta-buttons">
            <div class="vuelta-total">Cilindros: <span id="cil-v1-card">0</span></div>
            <button class="btn-sec btn-wa-vuelta" data-vuelta="1">
              WhatsApp / Imprimir
            </button>
            <button class="btn-sec btn-print-vuelta" data-vuelta="1">
              Imprimir vuelta
            </button>
          </div>
        </div>
        <div class="vuelta-body">
          <div class="vuelta-select-row">
            <span class="vuelta-select-label">Selección rápida (columna WSP):</span>
            <button class="btn-mini btn-sel" data-vuelta="1" data-mode="all">Todos</button>
            <button class="btn-mini btn-sel" data-vuelta="1" data-mode="with-cant">Solo con cantidad</button>
            <button class="btn-mini btn-sel" data-vuelta="1" data-mode="none">Ninguno</button>
          </div>
          <div class="tabla-wrap">
            <table>
              <thead>
                <tr>
                  <th class="col-taller">Taller</th>
                  <th class="col-tiene">Tiene</th>
                  <th class="col-wsp">WSP</th>
                  <th class="col-cant">Cantidad</th>
                  <th class="col-obs">Observaciones</th>
                </tr>
              </thead>
              <tbody id="tbody-v1"></tbody>
            </table>
          </div>
        </div>
      </article>

      <!-- VUELTA 2 -->
      <article class="vuelta-card" data-vuelta="2">
        <div class="vuelta-header">
          <div class="vuelta-info">
            <span class="toggle-icon">▼</span>
            <span class="vuelta-nombre">Vuelta 2</span>
          </div>
          <div class="vuelta-buttons">
            <div class="vuelta-total">Cilindros: <span id="cil-v2-card">0</span></div>
            <button class="btn-sec btn-wa-vuelta" data-vuelta="2">
              WhatsApp / Imprimir
            </button>
            <button class="btn-sec btn-print-vuelta" data-vuelta="2">
              Imprimir vuelta
            </button>
          </div>
        </div>
        <div class="vuelta-body">
          <div class="vuelta-select-row">
            <span class="vuelta-select-label">Selección rápida (columna WSP):</span>
            <button class="btn-mini btn-sel" data-vuelta="2" data-mode="all">Todos</button>
            <button class="btn-mini btn-sel" data-vuelta="2" data-mode="with-cant">Solo con cantidad</button>
            <button class="btn-mini btn-sel" data-vuelta="2" data-mode="none">Ninguno</button>
          </div>
          <div class="tabla-wrap">
            <table>
              <thead>
                <tr>
                  <th class="col-taller">Taller</th>
                  <th class="col-tiene">Tiene</th>
                  <th class="col-wsp">WSP</th>
                  <th class="col-cant">Cantidad</th>
                  <th class="col-obs">Observaciones</th>
                </tr>
              </thead>
              <tbody id="tbody-v2"></tbody>
            </table>
          </div>
        </div>
      </article>

      <!-- VUELTA 3 -->
      <article class="vuelta-card" data-vuelta="3">
        <div class="vuelta-header">
          <div class="vuelta-info">
            <span class="toggle-icon">▼</span>
            <span class="vuelta-nombre">Vuelta 3</span>
          </div>
          <div class="vuelta-buttons">
            <div class="vuelta-total">Cilindros: <span id="cil-v3-card">0</span></div>
            <button class="btn-sec btn-wa-vuelta" data-vuelta="3">
              WhatsApp / Imprimir
            </button>
            <button class="btn-sec btn-print-vuelta" data-vuelta="3">
              Imprimir vuelta
            </button>
          </div>
        </div>
        <div class="vuelta-body">
          <div class="vuelta-select-row">
            <span class="vuelta-select-label">Selección rápida (columna WSP):</span>
            <button class="btn-mini btn-sel" data-vuelta="3" data-mode="all">Todos</button>
            <button class="btn-mini btn-sel" data-vuelta="3" data-mode="with-cant">Solo con cantidad</button>
            <button class="btn-mini btn-sel" data-vuelta="3" data-mode="none">Ninguno</button>
          </div>
          <div class="tabla-wrap">
            <table>
              <thead>
                <tr>
                  <th class="col-taller">Taller</th>
                  <th class="col-tiene">Tiene</th>
                  <th class="col-wsp">WSP</th>
                  <th class="col-cant">Cantidad</th>
                  <th class="col-obs">Observaciones</th>
                </tr>
              </thead>
              <tbody id="tbody-v3"></tbody>
            </table>
          </div>
        </div>
      </article>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDocs,
      onSnapshot,
      setDoc,
      updateDoc,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7p0rPT0sB4RGOqgHOu8gjdC8hcjuMO-8",
      authDomain: "crpc-cilindros.firebaseapp.com",
      projectId: "crpc-cilindros",
      storageBucket: "crpc-cilindros.firebasestorage.app",
      messagingSenderId: "6730395812",
      appId: "1:6730395812:web:327d3f031e05fdbd33f631",
      measurementId: "G-7FEQWXK5VB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colTalleres = collection(db, "talleres_reparto");

    // Ocultar splash al terminar animación
    const splashEl = document.getElementById("splash");
    if(splashEl){
      splashEl.addEventListener("animationend", () => {
        splashEl.style.display = "none";
      });
    }

    // Orden manual de ruta (por id) para que Calera Silvana y Calera Torres queden juntas
    const ordenManual = {
      // Vuelta 1
      "minuto-gnc":1,
      "silvana-calera":2,        // Calera Silvana
      "calera-torres-gnc":3,     // Calera Torres
      "zico":4,
      "colon-gnc":5,
      "tabach-gnc":6,
      "franco-alta-gracia":7,
      "servincor":8,
      "bruno-f":9,
      "porto-alta-gracia":10,
      "brochero-gnc":11,
      "valparaiso-gnc":12,

      // Vuelta 2
      "canovas":13,
      "malvinas-gnc":14,
      "genesis-gnc":15,
      "alem":16,
      "cars":17,
      "forteza-gnc":18,
      "enero-gas":19,
      "pepe":20,

      // Vuelta 3
      "san-francisco-gnc":21,
      "genovesio":22,
      "gnc-giordano":23,
      "tecno-gnc":24,
      "marcos-gnc":25,
      "franco-cba":26,
      "franc-villa-dolores":27,
      "leal":28,
      "misiti":29,
      "enjom":30,
      "alemanes":31,
      "acosta":32,     // se muestra como Rosso
      "ceriani":33
    };

    const defaultTalleres = [
      // Vuelta 1
      { id: "minuto-gnc", nombre: "Minuto GNC", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "calera-torres-gnc", nombre: "Calera Torres", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "silvana-calera", nombre: "Calera Silvana", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "zico", nombre: "Zico", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "colon-gnc", nombre: "Colón GNC", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "tabach-gnc", nombre: "Tabach GNC", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "franco-alta-gracia", nombre: "Franco Alta Gracia", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "servincor", nombre: "Servincor", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "bruno-f", nombre: "Bruno F", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "porto-alta-gracia", nombre: "Porto Alta Gracia", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "brochero-gnc", nombre: "Brochero GNC", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "valparaiso-gnc", nombre: "Valparaíso GNC", vuelta: 1, cilindrosPend: 0, cantidad: 0, obs: "" },

      // Vuelta 2
      { id: "canovas", nombre: "Cánovas", vuelta: 2, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "malvinas-gnc", nombre: "Malvinas GNC", vuelta: 2, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "genesis-gnc", nombre: "Génesis GNC", vuelta: 2, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "alem", nombre: "ALEM", vuelta: 2, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "cars", nombre: "Cars", vuelta: 2, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "forteza-gnc", nombre: "Forteza GNC", vuelta: 2, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "enero-gas", nombre: "Enero Gas", vuelta: 2, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "pepe", nombre: "Pepe", vuelta: 2, cilindrosPend: 0, cantidad: 0, obs: "" },

      // Vuelta 3
      { id: "san-francisco-gnc", nombre: "San Francisco GNC", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "genovesio", nombre: "Genovesio", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "gnc-giordano", nombre: "GNC Giordano", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "tecno-gnc", nombre: "Tecno GNC", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "marcos-gnc", nombre: "Marcos GNC", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "franco-cba", nombre: "Franco cba", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "franc-villa-dolores", nombre: "Franc Villa Dolores", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "leal", nombre: "Leal", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "misiti", nombre: "Misiti", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "enjom", nombre: "Enjom", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "alemanes", nombre: "Alemanes", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "acosta", nombre: "Rosso", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" },
      { id: "ceriani", nombre: "CERIANI", vuelta: 3, cilindrosPend: 0, cantidad: 0, obs: "" }
    ];

    const tbodyV1 = document.getElementById("tbody-v1");
    const tbodyV2 = document.getElementById("tbody-v2");
    const tbodyV3 = document.getElementById("tbody-v3");

    const cilTotalGeneralEl = document.getElementById("cil-total-general");
    const cilV1ResumenEl = document.getElementById("cil-v1");
    const cilV2ResumenEl = document.getElementById("cil-v2");
    const cilV3ResumenEl = document.getElementById("cil-v3");

    const cilV1CardEl = document.getElementById("cil-v1-card");
    const cilV2CardEl = document.getElementById("cil-v2-card");
    const cilV3CardEl = document.getElementById("cil-v3-card");

    const btnReset = document.getElementById("btn-reset");

    let talleres = [];

    async function actualizarCantidad(id, valor){
      let n = parseInt(valor, 10);
      if(isNaN(n) || n < 0) n = 0;
      const ref = doc(colTalleres, id);
      await updateDoc(ref, {
        cantidad: n,
        cilindrosPend: n > 0 ? 1 : 0
      });
    }

    async function actualizarObs(id, texto){
      const ref = doc(colTalleres, id);
      await updateDoc(ref, { obs: texto });
    }

    async function actualizarTiene(id, checked, inpCant){
      let n = parseInt(inpCant.value || "0", 10);
      if(checked){
        if(isNaN(n) || n <= 0){
          n = 1;
          inpCant.value = "1";
        }
      }else{
        n = 0;
        inpCant.value = "";
      }
      const ref = doc(colTalleres, id);
      await updateDoc(ref, {
        cantidad: n,
        cilindrosPend: checked ? 1 : 0
      });
    }

    async function reiniciarDia(){
      const ok = confirm("¿Reiniciar TODOS los datos de hoy? (cantidades y observaciones)");
      if(!ok) return;
      const snap = await getDocs(colTalleres);
      const batch = writeBatch(db);
      snap.forEach(d => {
        batch.update(d.ref, {
          cilindrosPend: 0,
          cantidad: 0,
          obs: ""
        });
      });
      await batch.commit();
    }

    function abrirPopupRuta(seleccion){
      const fechaStr = new Date().toLocaleDateString("es-AR");

      let textoWhatsapp = "";
      textoWhatsapp += "RETIRO CILINDROS - CRPC QUIROGA\n\n";
      textoWhatsapp += "Talleres a retirar:\n";

      const porVuelta = {};
      seleccion.forEach(item => {
        const v = item.vuelta || "?";
        if(!porVuelta[v]) porVuelta[v] = [];
        porVuelta[v].push(item);
      });

      Object.keys(porVuelta)
        .sort((a,b) => Number(a) - Number(b))
        .forEach(v => {
          textoWhatsapp += "\nVuelta " + v + ":\n";
          porVuelta[v].forEach(item => {
            textoWhatsapp +=
              "  - " + item.nombre +
              " | Cilindros: " + item.cantidad +
              (item.obs ? " | Obs: " + item.obs : "") +
              "\n";
          });
        });

      const popup = window.open("", "_blank");
      if(!popup) return;

      const docP = popup.document;
      const body = docP.body;
      docP.title = "Ruta cilindros";
      body.innerHTML = "";
      body.style.fontFamily = 'system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif';
      body.style.padding = "12px";

      const h2 = docP.createElement("h2");
      h2.textContent = "Ruta de retiro de cilindros";
      body.appendChild(h2);

      const pFecha = docP.createElement("p");
      pFecha.innerHTML = "<strong>Fecha:</strong> " + fechaStr;
      body.appendChild(pFecha);

      const table = docP.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.fontSize = "14px";
      table.style.marginTop = "8px";

      const thead = docP.createElement("thead");
      const trHead = docP.createElement("tr");
      ["#","Vuelta","Taller","Cant.","Obs."].forEach(text => {
        const th = docP.createElement("th");
        th.textContent = text;
        th.style.border = "1px solid #ccc";
        th.style.padding = "4px 6px";
        th.style.background = "#f3f4f6";
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = docP.createElement("tbody");
      seleccion.forEach((item, idx) => {
        const tr = docP.createElement("tr");
        const addCell = (txt, right=false) => {
          const td = docP.createElement("td");
          td.textContent = txt;
          td.style.border = "1px solid #ccc";
          td.style.padding = "4px 6px";
          if(right) td.style.textAlign = "right";
          tr.appendChild(td);
        };
        addCell(String(idx+1));
        addCell("Vuelta " + item.vuelta);
        addCell(item.nombre);
        addCell(String(item.cantidad), true);
        addCell(item.obs || "");
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      body.appendChild(table);

      const h3 = docP.createElement("h3");
      h3.textContent = "Texto para WhatsApp";
      h3.style.marginTop = "12px";
      body.appendChild(h3);

      const textarea = docP.createElement("textarea");
      textarea.value = textoWhatsapp;
      textarea.style.width = "100%";
      textarea.style.height = "150px";
      textarea.style.marginTop = "8px";
      textarea.style.fontFamily = "inherit";
      textarea.style.fontSize = "13px";
      body.appendChild(textarea);

      const actions = docP.createElement("div");
      actions.style.marginTop = "8px";
      actions.style.display = "flex";
      actions.style.gap = "8px";
      actions.style.flexWrap = "wrap";

      const styleBtn = (el, outline) => {
        el.style.padding = "6px 10px";
        el.style.borderRadius = "4px";
        el.style.border = "1px solid #d50000";
        el.style.fontSize = "13px";
        el.style.cursor = "pointer";
        el.style.textDecoration = "none";
        el.style.display = "inline-block";
        if(outline){
          el.style.background = "#fff";
          el.style.color = "#d50000";
        }else{
          el.style.background = "#d50000";
          el.style.color = "#fff";
        }
      };

      const btnPrint = docP.createElement("button");
      btnPrint.textContent = "Imprimir";
      styleBtn(btnPrint,false);
      btnPrint.onclick = () => popup.print();
      actions.appendChild(btnPrint);

      const linkWA = docP.createElement("a");
      linkWA.textContent = "Abrir WhatsApp";
      linkWA.href = "https://wa.me/?text=" + encodeURIComponent(textoWhatsapp);
      linkWA.target = "_blank";
      linkWA.rel = "noopener noreferrer";
      styleBtn(linkWA,true);
      actions.appendChild(linkWA);

      body.appendChild(actions);
    }

    // WhatsApp: usa TODOS los WSP marcados en cualquier vuelta
    function generarRutaPorVuelta(_vueltaBtn){
      const cards = document.querySelectorAll(".vuelta-card");
      const seleccion = [];

      cards.forEach(card => {
        const v = parseInt(card.getAttribute("data-vuelta"),10) || "?";
        const rows = card.querySelectorAll("tbody tr");

        rows.forEach(row => {
          const chkWsp = row.querySelector(".chk-wsp");
          if(!chkWsp || !chkWsp.checked) return;

          const cantInput = row.querySelector(".input-num");
          let cantidad = parseInt(cantInput && cantInput.value ? cantInput.value : "0",10);
          if(isNaN(cantidad) || cantidad <= 0){
            cantidad = 1;
          }

          const id = row.dataset.id;
          const nombreEl = row.querySelector(".col-taller span");
          const nombre = nombreEl ? nombreEl.textContent.trim() : "";
          const obsInput = row.querySelector(".input-text");
          const obs = obsInput ? obsInput.value.trim() : "";
          seleccion.push({ id, vuelta: v, nombre, cantidad, obs });
        });
      });

      if(seleccion.length === 0){
        alert("Marcá al menos un taller en la columna WSP (en cualquier vuelta).");
        return;
      }

      abrirPopupRuta(seleccion);
    }

    function renderVuelta(vuelta, tbody){
      tbody.innerHTML = "";
      const lista = talleres
        .filter(t => t.vuelta === vuelta)
        .sort((a,b) => {
          const oa = ordenManual[a.id] ?? 9999;
          const ob = ordenManual[b.id] ?? 9999;
          if(oa !== ob) return oa - ob;
          return a.nombre.localeCompare(b.nombre,"es");
        });

      lista.forEach(t => {
        const cant = Number(t.cantidad) || 0;
        const tieneFlag = (Number(t.cilindrosPend) || 0) > 0;
        const tiene = tieneFlag || cant > 0;

        const tr = document.createElement("tr");
        if(tiene) tr.classList.add("tiene");
        tr.dataset.id = t.id;

        // Taller
        const tdTaller = document.createElement("td");
        tdTaller.className = "col-taller";
        const nombreSpan = document.createElement("span");
        nombreSpan.textContent = t.nombre;
        tdTaller.appendChild(nombreSpan);
        tr.appendChild(tdTaller);

        // TIENE (persistente, sirve para imprimir)
        const tdTiene = document.createElement("td");
        tdTiene.className = "col-tiene";
        const chkTiene = document.createElement("input");
        chkTiene.type = "checkbox";
        chkTiene.className = "chk-tiene";
        chkTiene.checked = tieneFlag;
        tdTiene.appendChild(chkTiene);
        tr.appendChild(tdTiene);

        // WSP (solo para WhatsApp, no se guarda en DB)
        const tdWsp = document.createElement("td");
        tdWsp.className = "col-wsp";
        const chkWsp = document.createElement("input");
        chkWsp.type = "checkbox";
        chkWsp.className = "chk-wsp";
        tdWsp.appendChild(chkWsp);
        tr.appendChild(tdWsp);

        // Cantidad
        const tdCant = document.createElement("td");
        tdCant.className = "col-cant";
        const inpCant = document.createElement("input");
        inpCant.type = "number";
        inpCant.min = "0";
        inpCant.step = "1";
        inpCant.className = "input-num";
        inpCant.value = cant > 0 ? cant : "";
        tdCant.appendChild(inpCant);
        tr.appendChild(tdCant);

        // Observaciones
        const tdObs = document.createElement("td");
        tdObs.className = "col-obs";
        const inpObs = document.createElement("input");
        inpObs.type = "text";
        inpObs.className = "input-text";
        inpObs.value = t.obs || "";
        tdObs.appendChild(inpObs);
        tr.appendChild(tdObs);

        // Eventos
        chkTiene.addEventListener("change", () => {
          actualizarTiene(t.id, chkTiene.checked, inpCant);
        });

        inpCant.addEventListener("blur", () => {
          actualizarCantidad(t.id, inpCant.value);
        });
        inpCant.addEventListener("keydown", (e) => {
          if(e.key === "Enter") inpCant.blur();
        });

        inpObs.addEventListener("blur", () => {
          actualizarObs(t.id, inpObs.value.trim());
        });

        tbody.appendChild(tr);
      });
    }

    function render(){
      renderVuelta(1, tbodyV1);
      renderVuelta(2, tbodyV2);
      renderVuelta(3, tbodyV3);

      let total = 0, v1 = 0, v2 = 0, v3 = 0;
      talleres.forEach(t => {
        const c = Number(t.cantidad) || 0;
        total += c;
        if(t.vuelta === 1) v1 += c;
        if(t.vuelta === 2) v2 += c;
        if(t.vuelta === 3) v3 += c;
      });

      cilTotalGeneralEl.textContent = total;
      cilV1ResumenEl.textContent = v1;
      cilV2ResumenEl.textContent = v2;
      cilV3ResumenEl.textContent = v3;

      cilV1CardEl.textContent = v1;
      cilV2CardEl.textContent = v2;
      cilV3CardEl.textContent = v3;
    }

    // Imprimir usa TIENE por vuelta
    function imprimirVuelta(vuelta){
      const card = document.querySelector('.vuelta-card[data-vuelta="'+vuelta+'"]');
      if(!card) return;

      const rows = card.querySelectorAll("tbody tr");
      const seleccionadas = [];

      rows.forEach(row => {
        const chkTiene = row.querySelector(".chk-tiene");
        if(chkTiene && chkTiene.checked) seleccionadas.push(row);
      });

      if(seleccionadas.length === 0){
        alert("En la Vuelta " + vuelta + " marcá al menos un taller en la columna TIENE.");
        return;
      }

      // Aseguro que esta vuelta esté expandida
      card.classList.remove("collapsed");
      const icon = card.querySelector(".toggle-icon");
      if(icon) icon.textContent = "▼";

      // Oculto otras vueltas
      const todasCards = document.querySelectorAll(".vuelta-card");
      todasCards.forEach(c => {
        const v = parseInt(c.getAttribute("data-vuelta"),10);
        if(v !== vuelta) c.classList.add("print-hidden");
      });

      // Oculto filas de esta vuelta que no están seleccionadas en TIENE
      const filasOcultas = [];
      rows.forEach(row => {
        const chkTiene = row.querySelector(".chk-tiene");
        if(!chkTiene || !chkTiene.checked){
          row.classList.add("print-hidden");
          filasOcultas.push(row);
        }
      });

      window.print();

      // Restauro
      todasCards.forEach(c => c.classList.remove("print-hidden"));
      filasOcultas.forEach(r => r.classList.remove("print-hidden"));
    }

    function initBotonesVuelta(){
      const printBtns = document.querySelectorAll(".btn-print-vuelta");
      printBtns.forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const v = parseInt(btn.getAttribute("data-vuelta"),10);
          if(!isNaN(v)) imprimirVuelta(v);
        });
      });

      const waBtns = document.querySelectorAll(".btn-wa-vuelta");
      waBtns.forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const v = parseInt(btn.getAttribute("data-vuelta"),10);
          if(!isNaN(v)) generarRutaPorVuelta(v);
        });
      });
    }

    function initCollapsibles(){
      const cards = document.querySelectorAll(".vuelta-card");
      cards.forEach(card => {
        const header = card.querySelector(".vuelta-header");
        const icon = card.querySelector(".toggle-icon");
        if(!header) return;

        header.addEventListener("click", (e) => {
          if(e.target.closest(".btn-sec")) return;
          const isCollapsed = card.classList.toggle("collapsed");
          if(icon) icon.textContent = isCollapsed ? "►" : "▼";
        });
      });
    }

    // Selección rápida solo afecta WSP (WhatsApp)
    function aplicarSeleccionRapida(vuelta, mode){
      const card = document.querySelector('.vuelta-card[data-vuelta="'+vuelta+'"]');
      if(!card) return;

      const rows = card.querySelectorAll("tbody tr");
      if(rows.length === 0) return;

      rows.forEach(row => {
        const chkWsp = row.querySelector(".chk-wsp");
        const inpCant = row.querySelector(".input-num");
        if(!chkWsp) return;

        let n = parseInt(inpCant && inpCant.value ? inpCant.value : "0", 10);
        if(isNaN(n) || n < 0) n = 0;

        if(mode === "all"){
          chkWsp.checked = true;
        }else if(mode === "with-cant"){
          chkWsp.checked = n > 0;
        }else if(mode === "none"){
          chkWsp.checked = false;
        }
      });
    }

    function initSeleccionRapida(){
      const botones = document.querySelectorAll(".btn-sel");
      botones.forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const v = parseInt(btn.getAttribute("data-vuelta"),10);
          const mode = btn.getAttribute("data-mode");
          if(isNaN(v) || !mode) return;
          aplicarSeleccionRapida(v, mode);
        });
      });
    }

    async function inicializarDatos(){
      const snap = await getDocs(colTalleres);
      if(snap.empty){
        for(const t of defaultTalleres){
          await setDoc(doc(colTalleres, t.id), t);
        }
      }

      onSnapshot(colTalleres, snap2 => {
        const arr = [];
        snap2.forEach(d => {
          const data = d.data();
          // Forzamos nombres actualizados aunque en la DB estén viejos
          let nombre = data.nombre;
          if(d.id === "acosta") nombre = "Rosso";
          if(d.id === "silvana-calera") nombre = "Calera Silvana";
          if(d.id === "calera-torres-gnc") nombre = "Calera Torres";

          arr.push({
            id: d.id,
            nombre,
            vuelta: data.vuelta,
            cilindrosPend: data.cilindrosPend ?? 0,
            cantidad: data.cantidad ?? 0,
            obs: data.obs || ""
          });
        });
        talleres = arr;
        render();
      });

      if(btnReset) btnReset.addEventListener("click", reiniciarDia);

      initBotonesVuelta();
      initCollapsibles();
      initSeleccionRapida();
    }

    inicializarDatos();
  </script>
</body>
</html>
